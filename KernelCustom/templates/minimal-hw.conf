#!/bin/bash
TEMPLATE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

CONFIG="$TEMPLATE_DIR/../sources/linux/scripts/config"

# Couleurs
BLUE=$(tput setaf 6); GREEN=$(tput setaf 2); RED=$(tput setaf 1); BOLD=$(tput bold); RESET=$(tput sgr0)

# Logging
LOG_DIR="$TEMPLATE_DIR/../logs"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/kernelcustom-$(date +%Y%m%d-%H%M%S).log"
exec > >(tee -a "$LOG_FILE") 2>&1

echo "${BLUE}=== [Minimal-HW] Application du template pour mat√©riel physique ===${RESET}"
echo "üìÇ Dossier des templates : $TEMPLATE_DIR"
echo

echo "‚Üí Inclusion : base-minimal.conf"; bash "$TEMPLATE_DIR/base-minimal.conf"
echo "‚Üí Inclusion : modules.conf"; bash "$TEMPLATE_DIR/modules.conf"
echo "‚Üí Inclusion : vga-fallback.conf"; bash "$TEMPLATE_DIR/vga-fallback.conf"
echo "‚Üí Inclusion : usb-basic.conf"; bash "$TEMPLATE_DIR/usb-basic.conf"

echo; echo "${BLUE}=== Activation des drivers stockage essentiels ===${RESET}"
$CONFIG --enable CONFIG_ATA && echo "  ${GREEN}+ SATA activ√©${RESET}"
$CONFIG --enable CONFIG_SATA_AHCI && echo "  ${GREEN}+ AHCI activ√©${RESET}"
$CONFIG --enable CONFIG_BLK_DEV_GENERIC && echo "  ${GREEN}+ IDE g√©n√©rique activ√©${RESET}"
$CONFIG --enable CONFIG_BLK_DEV_PIIX && echo "  ${GREEN}+ PIIX activ√©${RESET}"
$CONFIG --enable CONFIG_MEGARAID_SAS && echo "  ${GREEN}+ MegaRAID SAS activ√©${RESET}"
$CONFIG --enable CONFIG_MEGARAID_MAILBOX && echo "  ${GREEN}+ MegaRAID Mailbox activ√©${RESET}"
$CONFIG --enable CONFIG_SCSI_AACRAID && echo "  ${GREEN}+ AACRAID activ√©${RESET}"
$CONFIG --enable CONFIG_SCSI_MPT3SAS && echo "  ${GREEN}+ MPT3SAS activ√©${RESET}"
$CONFIG --enable CONFIG_SCSI_MPT2SAS && echo "  ${GREEN}+ MPT2SAS activ√©${RESET}"
$CONFIG --enable CONFIG_BLK_DEV_NVME && echo "  ${GREEN}+ NVMe activ√©${RESET}"
$CONFIG --enable CONFIG_NVME_CORE && echo "  ${GREEN}+ NVMe Core activ√©${RESET}"
$CONFIG --enable CONFIG_NVME_MULTIPATH && echo "  ${GREEN}+ NVMe Multipath activ√©${RESET}"

echo; echo "${BLUE}=== Activation des drivers r√©seau de base ===${RESET}"
$CONFIG --enable CONFIG_E1000E && echo "  ${GREEN}+ Intel E1000E activ√©${RESET}"
$CONFIG --enable CONFIG_IGB && echo "  ${GREEN}+ Intel IGB activ√©${RESET}"
$CONFIG --enable CONFIG_R8169 && echo "  ${GREEN}+ Realtek R8169 activ√©${RESET}"

echo; echo "${BLUE}=== [Crypto] Configuration de la signature des modules ===${RESET}"
bash "$TEMPLATE_DIR/crypto-modsig.conf"

echo; echo "‚úÖ ${BOLD}${GREEN}[Minimal-HW] Template appliqu√© avec succ√®s.${RESET}"
echo "üìú Log sauvegard√© dans : $LOG_FILE"
$CONFIG --set-str MODULE_SIG_KEY "certs/signing_key.pem"
$CONFIG --enable MODULE_SIG_KEY_TYPE_RSA
$CONFIG --enable SYSTEM_TRUSTED_KEYRING
$CONFIG --set-str SYSTEM_TRUSTED_KEYS ""
