#!/bin/bash
#
# KernelCustom Manager Helper Script
# This script performs privileged operations with PolicyKit authentication
#

set -e

ACTION="$1"
shift

case "$ACTION" in
    install-packages)
        # Install kernel packages
        dpkg -i "$@"
        apt-get install -f -y
        ;;

    remove-packages)
        # Remove kernel packages
        apt purge -y "$@"
        apt autoremove -y
        ;;

    reboot)
        # Reboot system
        systemctl reboot
        ;;

    copy-sources)
        # Copy kernel sources to /usr/src/
        SOURCE="$1"
        DEST="$2"
        cp -r "$SOURCE" "$DEST"
        ;;

    create-link)
        # Create symbolic link in /usr/src/
        TARGET="$1"
        LINK="$2"
        ln -sf "$TARGET" "$LINK"
        ;;

    remove-sources)
        # Remove kernel sources from /usr/src/
        rm -rf "$1"
        ;;

    mokutil-list-enrolled)
        # List enrolled MOK keys
        mokutil --list-enrolled
        ;;

    mokutil-list-new)
        # List pending MOK keys
        mokutil --list-new
        ;;

    mokutil-import)
        # Import MOK key
        mokutil --import "$@"
        ;;

    mokutil-delete)
        # Delete MOK key
        mokutil --delete "$@"
        ;;

    mokutil-reset)
        # Reset all MOK keys
        mokutil --reset
        ;;

    mokutil-diagnose)
        # Run all diagnostic commands in one go (prevents multiple password prompts)
        # Output format: ENROLLED:<output>\nPENDING:<output>
        # NOTE: mokutil peut retourner un code non-zéro même avec une sortie valide (bug Debian 13)
        # On utilise '|| true' pour ignorer le return code et toujours retourner la sortie
        echo "ENROLLED:"
        mokutil --list-enrolled 2>&1 || true
        echo "PENDING:"
        mokutil --list-new 2>&1 || true
        ;;

    modinfo-check)
        # Check module signature info (requires root on Debian 13)
        # Usage: modinfo-check <module_path>
        MODULE_PATH="$1"
        if [ ! -f "$MODULE_PATH" ]; then
            echo "ERROR:Module not found"
            exit 1
        fi

        # Get sig_id
        SIG_ID=$(modinfo -F sig_id "$MODULE_PATH" 2>/dev/null || echo "")

        # Get signer
        SIGNER=$(modinfo -F signer "$MODULE_PATH" 2>/dev/null || echo "")

        # Output in parseable format
        echo "SIG_ID:$SIG_ID"
        echo "SIGNER:$SIGNER"
        ;;

    *)
        echo "Unknown action: $ACTION" >&2
        echo "Usage: $0 {install-packages|remove-packages|reboot|copy-sources|create-link|remove-sources|mokutil-*|modinfo-check} [args...]" >&2
        exit 1
        ;;
esac

exit 0
